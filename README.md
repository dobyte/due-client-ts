# due-client-ts 

### 1.ä»‹ç»

dueæ˜¯ä¸€æ¬¾åŸºäºŽGoè¯­è¨€å¼€å‘çš„è½»é‡çº§ã€é«˜æ€§èƒ½åˆ†å¸ƒå¼æ¸¸æˆæœåŠ¡å™¨æ¡†æž¶ã€‚
å…¶ä¸­ï¼Œæ¨¡å—è®¾è®¡æ–¹é¢å€Ÿé‰´äº†[kratos](https://github.com/go-kratos/kratos)çš„æ¨¡å—è®¾è®¡æ€è·¯ï¼Œæ—¨åœ¨ä¸ºæ¸¸æˆæœåŠ¡å™¨å¼€å‘æä¾›å®Œå–„ã€é«˜æ•ˆã€æ ‡å‡†åŒ–çš„è§£å†³æ–¹æ¡ˆã€‚
æ¡†æž¶è‡ªåˆ›å»ºè‡³ä»Šå·²åœ¨å¤šä¸ªä¼ä¸šçº§æ¸¸æˆé¡¹ç›®ä¸­ä¸Šçº¿å®žè·µè¿‡ï¼Œç¨³å®šæ€§æœ‰å……åˆ†çš„ä¿éšœã€‚

### 2.ä¼˜åŠ¿

* ðŸ’¡ ç®€å•æ€§ï¼šæž¶æž„ç®€å•ï¼Œæºç ç®€æ´æ˜“ç†è§£ã€‚
* ðŸš  ä¾¿æ·æ€§ï¼šä»…æš´éœ²å¿…è¦çš„è°ƒç”¨æŽ¥å£ï¼Œå‡è½»å¼€å‘è€…çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚
* ðŸš€ é«˜æ€§èƒ½ï¼šæ¡†æž¶åŽŸç”Ÿå®žçŽ°é›†ç¾¤é€šä¿¡æ–¹æ¡ˆï¼Œæ™®é€šæœºå™¨å•çº¿ç¨‹ä¹Ÿèƒ½è½»æ¾å®žçŽ°20Wçš„TPSã€‚
* ðŸ§Š æ ‡å‡†åŒ–ï¼šæ¡†æž¶åŽŸç”Ÿæä¾›æ ‡å‡†åŒ–çš„å¼€å‘è§„èŒƒï¼Œæ— è®ºå¤šä¹ˆå¤æ‚çš„é¡¹ç›®ä¹Ÿèƒ½è½»æ¾åº”å¯¹ã€‚
* âœˆï¸ é«˜æ•ˆæ€§ï¼šæ¡†æž¶åŽŸç”Ÿæä¾›tcpã€kcpã€wsç­‰åè®®çš„æœåŠ¡å™¨ï¼Œæ–¹ä¾¿å¼€å‘è€…å¿«é€Ÿæž„å»ºå„ç§ç±»åž‹çš„ç½‘å…³æœåŠ¡å™¨ã€‚
* âš–ï¸ ç¨³å®šæ€§ï¼šæ‰€æœ‰å‘å¸ƒçš„æ­£å¼ç‰ˆæœ¬å‡å·²é€šè¿‡å†…éƒ¨çœŸå®žä¸šåŠ¡çš„ä¸¥æ ¼æµ‹è¯•ï¼Œå…·å¤‡è¾ƒé«˜çš„ç¨³å®šæ€§ã€‚
* ðŸŽŸï¸ æ‰©å±•æ€§ï¼šé‡‡ç”¨è‰¯å¥½çš„æŽ¥å£è®¾è®¡ï¼Œæ–¹ä¾¿å¼€å‘è€…è®¾è®¡å®žçŽ°è‡ªæœ‰åŠŸèƒ½ã€‚
* ðŸ”‘ å¹³æ»‘æ€§ï¼šå¼•å…¥ä¿¡å·é‡ï¼Œé€šè¿‡æŽ§åˆ¶æœåŠ¡æ³¨å†Œä¸­å¿ƒæ¥å®žçŽ°ä¼˜é›…åœ°æ»šåŠ¨æ›´æ–°ã€‚
* ðŸ”© æ‰©å®¹æ€§ï¼šé€šè¿‡ä¼˜é›…çš„è·¯ç”±åˆ†å‘æœºåˆ¶ï¼Œç†è®ºä¸Šå¯å®žçŽ°æ— é™æ‰©å®¹ã€‚
* ðŸ”§ æ˜“è°ƒè¯•ï¼šæ¡†æž¶åŽŸç”Ÿæä¾›äº†tcpã€kcpã€wsç­‰åè®®çš„å®¢æˆ·ç«¯ï¼Œæ–¹ä¾¿å¼€å‘è€…è¿›è¡Œç‹¬ç«‹çš„è°ƒè¯•å…¨æµç¨‹è°ƒè¯•ã€‚
* ðŸ§° å¯ç®¡ç†ï¼šæä¾›å®Œå–„çš„åŽå°ç®¡ç†æŽ¥å£ï¼Œæ–¹ä¾¿å¼€å‘è€…å¿«é€Ÿå®žçŽ°è‡ªå®šä¹‰çš„åŽå°ç®¡ç†åŠŸèƒ½ã€‚

### 3.åŠŸèƒ½

* ç½‘å…³ï¼šæ”¯æŒtcpã€kcpã€wsç­‰åè®®çš„ç½‘å…³æœåŠ¡å™¨ã€‚
* æ—¥å¿—ï¼šæ”¯æŒstdã€zapã€logrusã€aliyunã€tencentç­‰å¤šç§æ—¥å¿—ç»„ä»¶ã€‚
* æ³¨å†Œï¼šæ”¯æŒconsulã€etcdã€nacosç­‰å¤šç§æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚
* åè®®ï¼šæ”¯æŒjsonã€protobufã€msgpackç­‰å¤šç§é€šä¿¡åè®®ã€‚
* é…ç½®ï¼šæ”¯æŒconsulã€etcdã€nacosç­‰å¤šç§é…ç½®ä¸­å¿ƒï¼›å¹¶æ”¯æŒjsonã€yamlã€tomlã€xmlç­‰å¤šç§æ–‡ä»¶æ ¼å¼ã€‚
* é€šä¿¡ï¼šæ”¯æŒgrpcã€rpcxç­‰å¤šç§é«˜æ€§èƒ½é€šä¿¡æ–¹æ¡ˆã€‚
* é‡å¯ï¼šæ”¯æŒæœåŠ¡å™¨çš„å¹³æ»‘é‡å¯ã€‚
* äº‹ä»¶ï¼šæ”¯æŒredisã€natsã€kafkaã€rabbitMQç­‰äº‹ä»¶æ€»çº¿å®žçŽ°æ–¹æ¡ˆã€‚
* åŠ å¯†ï¼šæ”¯æŒrsaã€eccç­‰å¤šç§åŠ å¯†æ–¹æ¡ˆã€‚
* æœåŠ¡ï¼šæ”¯æŒgrpcã€rpcxç­‰å¤šç§å¾®æœåŠ¡è§£å†³æ–¹æ¡ˆã€‚
* çµæ´»ï¼šæ”¯æŒå•ä½“ã€åˆ†å¸ƒå¼ç­‰å¤šç§æž¶æž„æ–¹æ¡ˆã€‚
* ç®¡ç†ï¼šæä¾›masteråŽå°ç®¡ç†æœç›¸å…³æŽ¥å£æ”¯æŒã€‚
* Webï¼šæä¾›httpåè®®çš„fiberæœåŠ¡å™¨åŠswaggeræ–‡æ¡£è§£å†³æ–¹æ¡ˆã€‚
* å·¥å…·ï¼šæä¾›[due-cli](https://github.com/dobyte/due-cli)è„šæ‰‹æž¶å·¥å…·ç®±ï¼Œå¯å¿«é€Ÿæž„å»ºé›†ç¾¤é¡¹ç›®ã€‚
* Actorï¼šæä¾›å®Œå–„actoræ¨¡åž‹è§£å†³æ–¹æ¡ˆã€‚

### 4.å®‰è£…

npmå®‰è£…

```bash
$ npm install due-client
```

yarnå®‰è£…

```bash
$ yarn add due-client
```

### 5.ä½¿ç”¨

```js
import { Client, Packer } from 'due-client';

// è¯·æ±‚æ•°æ®åŒ…
const buffer = (new TextEncoder).encode(JSON.stringify({
    message: 'hello server'
}));

// åˆ›å»ºå®¢æˆ·ç«¯
const client = new Client({
    url: 'ws://127.0.0.1:3553',
    heartbeat: 10000,
    packer: new Packer({
        byteOrder: 'big',
        seqBytes: 0,
        routeBytes: 4,
        bufferBytes: 5000
    })
});

// å‘é€è¯·æ±‚å“åº”
const request = (c) => {
    let counter = 0;

    let i = setInterval(() => {
        if (counter >= 10) {
            // æ¸…ç†å®šæ—¶å™¨
            clearInterval(i);
            // å…³é—­è¿žæŽ¥
            c.disconnect();
        }

        // å‘é€æ¶ˆæ¯
        try {
            c.request(1, buffer, 2000).then((message) => {
                document.write('response message: ', (new TextDecoder).decode(message.buffer), '<br/>');
            }).catch(() => {
                document.write('reject', '<br/>');
            });

            counter++;
        } catch (error) {
            console.log(error);
        }
    }, 1000);
}

// å‘é€å¼‚æ­¥æ¶ˆæ¯
const send = (c) => {
    let counter = 0;

    let i = setInterval(() => {
        if (counter >= 10) {
            // æ¸…ç†å®šæ—¶å™¨
            clearInterval(i);
            // å…³é—­è¿žæŽ¥
            c.disconnect();
        }

        // å‘é€æ¶ˆæ¯
        try {
            c.send({
                route: 1,
                buffer: buffer
            });

            counter++;
        } catch (error) {
            console.log(error);
        }
    }, 1000);
}

// ç›‘å¬è¿žæŽ¥
client.onConnect((c) => {
    document.write('connect success', '<br/>');

    // å‘é€åŒæ­¥è¯·æ±‚ï¼Œéœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŒæ—¶å¼€å¯seqé…ç½®
    request(c);

    // å‘é€å¼‚æ­¥æ¶ˆæ¯
    // send(c);
});

// ç›‘å¬è¿žæŽ¥æ–­å¼€
client.onDisconnect((c) => {
    document.write('disconnect success', '<br/>');

    // é‡æ–°è¿žæŽ¥
    c.connect();
});

// ç›‘å¬æŽ¥æ”¶åˆ°æ¶ˆæ¯
client.onReceive((c, message) => {
    document.write('receive message: ', (new TextDecoder).decode(message.buffer), '<br/>');
});

// ç›‘å¬æŽ¥å—æœåŠ¡å™¨çš„å¿ƒè·³é™„å¸¦çš„æœåŠ¡å™¨æ—¶é—´
client.onHeartbeat((c, millisecond) => {
    millisecond && document.write("server heartbeat timestamp: ", millisecond, '<br/>');
});

// å»ºç«‹è¿žæŽ¥
client.connect();
```

## License

[MIT](https://tldrlegal.com/license/mit-license)